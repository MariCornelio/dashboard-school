<div class="card">
  <p-toast />
  <app-loader-dialog [visible]="loadingDeleteCourse" [message]="'Eliminando curso'" />
  <p-table #tableCourses [value]="coursesStoreSvc.courses()" dataKey="id" [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]" [loading]="coursesStoreSvc.loadingCourses()" [showLoader]="false"
    (onPage)="coursesStoreSvc.onCurrentPageCourse($event.first)" [paginator]="coursesStoreSvc.courses().length !== 0"
    [globalFilterFields]="['name', 'description', 'startDate', 'endDate', 'active']"
    [tableStyle]="{ 'min-width': '75rem' }" class="overflow-y-hidden">
    <ng-template #caption>
      <div class="flex gap-2 items-center justify-center max-sm:flex-col">
        <p-button label="Agregar Curso" icon="pi pi-plus" (onClick)="openNewCourse()" class="max-sm:w-full"
          styleClass="max-sm:w-full" />
        <p-iconfield iconPosition="left" class="ml-auto max-sm:w-full">
          <p-inputicon>
            <i class="pi pi-search"></i>
          </p-inputicon>
          <input pInputText type="text" #InputFilterGlobal
            (input)="tableCourses.filterGlobal(InputFilterGlobal.value, 'contains')"
            placeholder="Escribe para buscar..." class="max-sm:w-full" />
        </p-iconfield>
      </div>
    </ng-template>
    <ng-template #header>
      <tr>
        <th></th>
        <th style="min-width:12rem">Nombre</th>
        <th style="min-width:15rem">Descripción</th>
        <th style="min-width:14rem">Inicio</th>
        <th style="min-width:14rem">Fin</th>
        <th style="min-width:8rem">Horas</th>
        <th style="min-width:8rem">Precio (S/)</th>
        <th style="min-width:12rem">Profesor(es)</th>
        <th style="min-width:8rem;text-align:center">Activo</th>
        <th style="min-width:12rem;text-align:center">Acciones</th>
      </tr>
      <tr>
        <th></th>
        <th>
          <p-columnFilter type="text" field="name" placeholder="Buscar por nombre" ariaLabel="Filtrar por nombre"
            filterOn="input" matchMode="contains" [showMenu]="false"></p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="text" field="description" placeholder="Buscar por descripción"
            ariaLabel="Filtrar por Descripción" filterOn="input" matchMode="contains"
            [showMenu]="false"></p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="date" field="startDate" placeholder="Buscar por fecha"
            ariaLabel="Filtrar por fecha de inicio" filterOn="input"></p-columnFilter>
        </th>
        <th>
          <p-columnFilter type="date" field="endDate" placeholder="Buscar por fecha"
            ariaLabel="Filtrar por fecha de término" filterOn="input"></p-columnFilter>
        </th>
        <th></th>
        <th></th>
        <th></th>
        <th style="text-align: center;">
          <p-columnFilter type="boolean" field="active" display="menu"></p-columnFilter>
        </th>
        <th></th>
      </tr>
    </ng-template>

    <!-- Cuando loading = true -->
    <ng-template #loadingbody>
      @for (_ of skeletonArray; track $index) {
      <tr>
        <td><p-skeleton width="100%"></p-skeleton></td>
        <td><p-skeleton width="100%"></p-skeleton></td>
        <td><p-skeleton width="100%"></p-skeleton></td>
        <td><p-skeleton width="100%"></p-skeleton></td>
        <td><p-skeleton width="100%"></p-skeleton></td>
        <td><p-skeleton width="100%"></p-skeleton></td>
        <td><p-skeleton width="100%"></p-skeleton></td>
        <td><p-skeleton width="100%"></p-skeleton></td>
        <td>
          <div class="flex justify-center">
            <p-skeleton shape="circle" size="2rem"></p-skeleton>
          </div>
        </td>
        <td>
          <div class="flex justify-center">
            <p-skeleton shape="circle" size="2rem"></p-skeleton>
          </div>
        </td>
      </tr>
      }
    </ng-template>

    <!-- Cuando loading = false -->
    <ng-template #body let-course let-rowIndex="rowIndex">
      <tr>
        <td>{{rowIndex + 1}}</td>
        <td>
          {{course.name}}
        </td>
        <td>{{ course.description }}</td>
        <td>{{ course.startDate | date: 'dd/MM/yy'}}</td>
        <td>{{ course.endDate | date: 'dd/MM/yy' }}</td>
        <td>{{course.durationHours}}</td>
        <td>{{course.price | currency :'PEN':'S/. ':'1.2-2' }}</td>
        <td>
          @if (assignmentsStoreSvc.loadingCoursesMap()[course.id]) {
          <p-skeleton width="100%"></p-skeleton>
          }@else {
          <ol>
            @for (teacher of assignmentsStoreSvc.coursesTeachersMap()[course.id]; track teacher.id) {
            <li>{{teacher.name}}</li>
            }
          </ol>
          }
        </td>
        <td style="text-align:center;">
          <i class="pi" [ngClass]="{
                 'text-green-500 pi-check-circle': course.active,
                 'text-red-500 pi-times-circle': !course.active
               }">
          </i>
        </td>
        <td>
          <div class="flex justify-center">
            <p-button [icon]="'pi pi-pencil'" class="mr-2" [rounded]="true" [outlined]="true"
              (onClick)="openEditCourse(course)" />
            <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true"
              (onClick)="confirmDelete.show()" />
          </div>
        </td>
      </tr>
      <!-- Modal para eliminar usuario -->
      <app-delete-dialog #confirmDelete [header]="'Eliminar Curso'"
        [message]="`Deseas eliminar a ${course.name} de forma permanente?`" (onAccept)="deleteCourse(course)" />
    </ng-template>
    <ng-template #emptymessage>
      <tr>
        <td colspan="10">No se encontró cursos disponibles.</td>
      </tr>
    </ng-template>
  </p-table>
</div>
<app-modal-course />